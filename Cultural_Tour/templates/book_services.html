{% extends "base.html" %}
{% block title %}Book Services - {{ place.name }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('place_detail', place_id=place.id) }}">{{ place.name }}</a></li>
          <li class="breadcrumb-item active">Book Services</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Book Hotels & Transport for {{ place.name }}</h4>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('book_services', place_id=place.id) }}">
            
            <!-- Customer Details -->
            <div class="mb-4">
              <h5 class="mb-3">
                <i class="bi bi-person-circle text-primary"></i> Your Details
              </h5>
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="customer_name" class="form-label">Full Name *</label>
                  <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                </div>
                <div class="col-md-4">
                  <label for="customer_email" class="form-label">Email *</label>
                  <input type="email" class="form-control" id="customer_email" name="customer_email" required>
                </div>
                <div class="col-md-4">
                  <label for="customer_phone" class="form-label">Phone *</label>
                  <input type="tel" class="form-control" id="customer_phone" name="customer_phone" required>
                </div>
              </div>
            </div>

            <!-- Hotel Selection -->
            <div class="mb-4">
              <h5 class="mb-3">
                <i class="bi bi-building text-primary"></i> Select Hotel (Optional)
              </h5>
              
              {% if hotels %}
                <div class="row g-3">
                  {% for hotel in hotels %}
                  <div class="col-md-6">
                    <div class="card hotel-card">
                      <div class="card-body">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="hotel_id" 
                                 id="hotel{{ hotel.id }}" value="{{ hotel.id }}">
                          <label class="form-check-label w-100" for="hotel{{ hotel.id }}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                              <h6 class="mb-0">{{ hotel.name }}</h6>
                              <span class="badge bg-success">₹{{ '%.0f'|format(hotel.price_per_night) }}/night</span>
                            </div>
                            {% if hotel.rating %}
                              <div class="mb-2">
                                <span class="badge bg-warning text-dark">{{ hotel.rating }} ★</span>
                              </div>
                            {% endif %}
                            {% if hotel.description %}
                              <p class="small text-muted mb-2">{{ hotel.description }}</p>
                            {% endif %}
                            {% if hotel.amenities %}
                              <div class="small">
                                <strong>Amenities:</strong> {{ hotel.amenities }}
                              </div>
                            {% endif %}
                            {% if hotel.contact_info %}
                              <div class="small text-muted mt-1">
                                <i class="bi bi-telephone"></i> {{ hotel.contact_info }}
                              </div>
                            {% endif %}
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i> No hotels available for this location.
                </div>
              {% endif %}
            </div>

            <!-- Transport Selection -->
            <div class="mb-4">
              <h5 class="mb-3">
                <i class="bi bi-geo-alt text-primary"></i> Select Transport (Optional)
              </h5>
              
              {% if transports %}
                <div class="row g-3">
                  {% for transport in transports %}
                  <div class="col-md-6">
                    <div class="card transport-card">
                      <div class="card-body">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="transport_id" 
                                 id="transport{{ transport.id }}" value="{{ transport.id }}">
                          <label class="form-check-label w-100" for="transport{{ transport.id }}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                              <h6 class="mb-0">{{ transport.name }}</h6>
                              <span class="badge 
                                {% if transport.transport_type == 'bus' %}bg-info
                                {% elif transport.transport_type == 'cab' %}bg-warning
                                {% elif transport.transport_type == 'train' %}bg-success
                                {% else %}bg-secondary{% endif %}">
                                {{ transport.transport_type|upper }}
                              </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <span class="text-success fw-bold">₹{{ '%.0f'|format(transport.price) }}</span>
                              {% if transport.duration_hours %}
                                <small class="text-muted">{{ transport.duration_hours }} hours</small>
                              {% endif %}
                            </div>
                            {% if transport.description %}
                              <p class="small text-muted mb-2">{{ transport.description }}</p>
                            {% endif %}
                            {% if transport.capacity %}
                              <div class="small">
                                <strong>Capacity:</strong> {{ transport.capacity }} people
                              </div>
                            {% endif %}
                            {% if transport.operating_hours %}
                              <div class="small text-muted">
                                <i class="bi bi-clock"></i> {{ transport.operating_hours }}
                              </div>
                            {% endif %}
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i> No transport services available for this location.
                </div>
              {% endif %}
            </div>

            <!-- Booking Details -->
            <div class="mb-4">
              <h5 class="mb-3">
                <i class="bi bi-calendar-check text-primary"></i> Booking Details
              </h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="check_in" class="form-label">Check-in Date</label>
                  <input type="date" class="form-control" id="check_in" name="check_in" 
                         min="{{ today }}">
                </div>
                <div class="col-md-6">
                  <label for="check_out" class="form-label">Check-out Date</label>
                  <input type="date" class="form-control" id="check_out" name="check_out" 
                         min="{{ tomorrow }}">
                </div>
                <div class="col-md-6">
                  <label for="num_people" class="form-label">Number of People *</label>
                  <input type="number" class="form-control" id="num_people" name="num_people" 
                         min="1" value="1" required>
                </div>
                <div class="col-md-6">
                  <label for="num_rooms" class="form-label">Number of Rooms</label>
                  <input type="number" class="form-control" id="num_rooms" name="num_rooms" 
                         min="1" value="1">
                </div>
                <div class="col-12">
                  <label for="special_requests" class="form-label">Special Requests</label>
                  <textarea class="form-control" id="special_requests" name="special_requests" 
                            rows="3" placeholder="Any special requirements or requests..."></textarea>
                </div>
              </div>
            </div>

            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> 
              <strong>Note:</strong> You must select at least one service (hotel or transport) to proceed with booking.
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                <i class="bi bi-cart-check"></i> Book Selected Services
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Sidebar Summary -->
    <div class="col-lg-4">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-header">
          <h5 class="mb-0">Booking Summary</h5>
        </div>
        <div class="card-body">
          <h6>{{ place.name }}</h6>
          <p class="text-muted small">{{ place.city }}, {{ place.state }}</p>
          
          <div class="mt-4">
            <h6>Selected Services:</h6>
            <ul class="list-group list-group-flush" id="selectedServices">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                No services selected
                <span class="text-muted">-</span>
              </li>
            </ul>
          </div>

          <div class="mt-3 pt-3 border-top">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Estimated Total:</strong>
              <strong id="totalAmount">₹0</strong>
            </div>
            <small class="text-muted">Final amount may vary based on availability</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectedServices = document.getElementById('selectedServices');
  const totalAmount = document.getElementById('totalAmount');
  const submitBtn = document.getElementById('submitBtn');
  const today = new Date().toISOString().split('T')[0];
  
  // Set min dates
  document.getElementById('check_in').min = today;
  
  function updateSummary() {
    let services = [];
    let total = 0;
    let hasSelection = false;
    
    // Get selected hotel
    const selectedHotel = document.querySelector('input[name="hotel_id"]:checked');
    const numRooms = parseInt(document.getElementById('num_rooms').value) || 1;
    const checkIn = document.getElementById('check_in').value;
    const checkOut = document.getElementById('check_out').value;
    
    if (selectedHotel && checkIn && checkOut) {
      const hotelCard = selectedHotel.closest('.hotel-card');
      const hotelName = hotelCard.querySelector('h6').textContent;
      const hotelPrice = parseFloat(hotelCard.querySelector('.badge.bg-success').textContent.replace('₹', '').replace('/night', ''));
      
      // Calculate days
      const start = new Date(checkIn);
      const end = new Date(checkOut);
      const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
      
      if (days > 0) {
        const hotelTotal = hotelPrice * days * numRooms;
        services.push({
          name: `${hotelName} (${days} night${days > 1 ? 's' : ''}, ${numRooms} room${numRooms > 1 ? 's' : ''})`,
          price: hotelTotal
        });
        total += hotelTotal;
        hasSelection = true;
      }
    } else if (selectedHotel) {
      const hotelCard = selectedHotel.closest('.hotel-card');
      const hotelName = hotelCard.querySelector('h6').textContent;
      const hotelPrice = parseFloat(hotelCard.querySelector('.badge.bg-success').textContent.replace('₹', '').replace('/night', ''));
      
      services.push({
        name: `${hotelName} (price per night)`,
        price: hotelPrice * numRooms
      });
      total += hotelPrice * numRooms;
      hasSelection = true;
    }
    
    // Get selected transport
    const selectedTransport = document.querySelector('input[name="transport_id"]:checked');
    const numPeople = parseInt(document.getElementById('num_people').value) || 1;
    
    if (selectedTransport) {
      const transportCard = selectedTransport.closest('.transport-card');
      const transportName = transportCard.querySelector('h6').textContent;
      const transportPrice = parseFloat(transportCard.querySelector('.text-success').textContent.replace('₹', ''));
      const transportTotal = transportPrice * numPeople;
      
      services.push({
        name: `${transportName} (${numPeople} person${numPeople > 1 ? 's' : ''})`,
        price: transportTotal
      });
      total += transportTotal;
      hasSelection = true;
    }
    
    // Update UI
    selectedServices.innerHTML = '';
    if (!hasSelection) {
      selectedServices.innerHTML = `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          No services selected
          <span class="text-muted">-</span>
        </li>
      `;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-cart-check"></i> Select at least one service';
    } else {
      services.forEach(service => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <small>${service.name}</small>
          <span class="text-success">₹${service.price.toFixed(0)}</span>
        `;
        selectedServices.appendChild(li);
      });
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-cart-check"></i> Book Selected Services';
    }
    
    totalAmount.textContent = `₹${total.toFixed(0)}`;
  }
  
  // Add event listeners
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', updateSummary);
  });
  
  document.getElementById('num_people').addEventListener('input', updateSummary);
  document.getElementById('num_rooms').addEventListener('input', updateSummary);
  document.getElementById('check_in').addEventListener('change', updateSummary);
  document.getElementById('check_out').addEventListener('change', updateSummary);
  
  // Update check_out min date when check_in changes
  document.getElementById('check_in').addEventListener('change', function() {
    const checkIn = this.value;
    if (checkIn) {
      const nextDay = new Date(checkIn);
      nextDay.setDate(nextDay.getDate() + 1);
      document.getElementById('check_out').min = nextDay.toISOString().split('T')[0];
    }
  });
  
  // Initial update
  updateSummary();
});
</script>
{% endblock %}